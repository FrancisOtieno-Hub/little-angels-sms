<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bulk Phone Update | Little Angels Academy</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="dashboard">
    <div class="page-header">
      <h1>Bulk Parent/Guardian Phone Update</h1>
      <div class="header-actions">
        <a href="dashboard.html" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        <button class="btn btn-danger" id="logoutBtn">Logout</button>
      </div>
    </div>
    
    <div id="alertContainer"></div>

    <!-- Instructions Card -->
    <div class="card">
      <h2>Instructions</h2>
      <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
        <h3 style="margin-top: 0;">How to Update Guardian Phone Numbers</h3>
        <ol style="line-height: 1.8;">
          <li><strong>Download Current Data:</strong> Click "Download Current Learners" to get Excel file with all learners</li>
          <li><strong>Add Phone Numbers:</strong> Open the Excel file and fill the <code>guardian_phone</code> column</li>
          <li><strong>Phone Format:</strong> Use format: <code>07xxxxxxxx</code> or <code>01xxxxxxxx</code> (Safaricom/Airtel)</li>
          <li><strong>Save File:</strong> Save the Excel file (keep same format)</li>
          <li><strong>Upload & Preview:</strong> Upload the file below and preview changes</li>
          <li><strong>Update Database:</strong> Review and click "Update All Phone Numbers"</li>
        </ol>
        
        <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 15px;">
          <strong>‚úÖ Valid Phone Formats:</strong><br>
          <code>0712345678</code>, <code>0122345678</code>, <code>+254712345678</code><br><br>
          <strong>‚ùå Invalid Formats:</strong><br>
          <code>712345678</code> (missing 0), <code>07123</code> (too short), <code>071234567890</code> (too long)
        </div>
      </div>
    </div>

    <!-- Step 1: Download Current Data -->
    <div class="card">
      <h2>Step 1: Download Current Learners Data</h2>
      <p class="text-muted">Download Excel file with all learners to add phone numbers offline</p>
      
      <div style="display: flex; gap: 12px; align-items: center; margin-top: 15px;">
        <button id="downloadBtn" class="btn btn-primary">
          Download Current Learners (Excel)
        </button>
        <span id="downloadStatus" class="text-muted"></span>
      </div>

      <div style="margin-top: 20px; padding: 12px; background: #fef3c7; border-radius: 6px;">
        <strong>üí° Tip:</strong> The downloaded file will have columns:
        <code>admission_no</code>, <code>first_name</code>, <code>last_name</code>, 
        <code>class</code>, <code>guardian_phone</code>. Fill only the <code>guardian_phone</code> column.
      </div>
    </div>

    <!-- Step 2: Upload Updated File -->
    <div class="card">
      <h2>Step 2: Upload Updated Excel File</h2>
      <p class="text-muted">Upload the Excel file with parent/guardian phone numbers added</p>
      
      <input type="file" id="excelFile" accept=".xlsx,.xls" style="margin: 15px 0;" />
      
      <button id="previewBtn" class="btn btn-primary">
        Preview Updates
      </button>

      <!-- Validation Summary -->
      <div id="validationSummary" class="hidden" style="margin-top: 20px; padding: 15px; border-radius: 8px;">
        <h3>Validation Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
          <div style="background: #f0fdf4; padding: 12px; border-radius: 6px;">
            <div style="font-size: 24px; font-weight: bold; color: #10b981;" id="validCount">0</div>
            <div style="color: #059669;">Valid Phone Numbers</div>
          </div>
          <div style="background: #fef3c7; padding: 12px; border-radius: 6px;">
            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;" id="invalidCount">0</div>
            <div style="color: #d97706;">Invalid/Empty Numbers</div>
          </div>
          <div style="background: #fce7f3; padding: 12px; border-radius: 6px;">
            <div style="font-size: 24px; font-weight: bold; color: #ec4899;" id="notFoundCount">0</div>
            <div style="color: #db2777;">Not Found in Database</div>
          </div>
          <div style="background: #e0e7ff; padding: 12px; border-radius: 6px;">
            <div style="font-size: 24px; font-weight: bold; color: #3b82f6;" id="totalRows">0</div>
            <div style="color: #2563eb;">Total Rows</div>
          </div>
        </div>
      </div>

      <!-- Preview Table -->
      <div id="previewContainer" class="hidden" style="margin-top: 20px;">
        <h3>Preview Changes (<span id="previewCount">0</span> records)</h3>
        
        <!-- Filter Buttons -->
        <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
          <button class="btn btn-secondary btn-sm" onclick="filterPreview('all')">Show All</button>
          <button class="btn btn-success btn-sm" onclick="filterPreview('valid')">‚úÖ Valid Only</button>
          <button class="btn btn-warning btn-sm" onclick="filterPreview('invalid')">‚ö†Ô∏è Invalid Only</button>
          <button class="btn btn-danger btn-sm" onclick="filterPreview('notfound')">‚ùå Not Found</button>
        </div>

        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
          <table id="previewTable" style="width: 100%;">
            <thead style="position: sticky; top: 0; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <tr>
                <th>Status</th>
                <th>Admission No</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Current Phone</th>
                <th>New Phone</th>
                <th>Validation</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 12px;">
          <button id="updateAllBtn" class="btn btn-success">
            ‚úÖ Update All Valid Phone Numbers
          </button>
          <button id="downloadInvalidBtn" class="btn btn-warning">
            üì• Download Invalid Records
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: Manual Entry (Optional) -->
    <div class="card">
      <h2>Step 3: Manual Entry (Optional)</h2>
      <p class="text-muted">Search and update phone number for a single learner</p>
      
      <div style="display: grid; gap: 12px; max-width: 600px; margin-top: 15px;">
        <!-- Search Input with Autocomplete -->
        <div style="position: relative;">
          <input 
            type="text" 
            id="learnerSearch" 
            placeholder="Search by name or admission number..." 
            autocomplete="off"
            style="width: 100%;"
          />
          
          <!-- Autocomplete Dropdown -->
          <div 
            id="searchResults" 
            class="hidden"
            style="
              position: absolute;
              top: 100%;
              left: 0;
              right: 0;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 4px 4px;
              max-height: 300px;
              overflow-y: auto;
              box-shadow: 0 4px 6px rgba(0,0,0,0.1);
              z-index: 1000;
            "
          ></div>
        </div>

        <!-- Selected Learner Display -->
        <div id="selectedLearner" class="hidden" style="padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #3b82f6;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <strong id="selectedLearnerName"></strong>
              <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">
                <span id="selectedLearnerAdm"></span> ‚Ä¢ <span id="selectedLearnerClass"></span>
              </div>
              <div style="font-size: 0.9rem; margin-top: 6px;">
                <div>Current Phone 1: <span id="selectedLearnerPhone" style="color: #3b82f6; font-weight: 500;"></span></div>
                <div style="margin-top: 2px;">Current Phone 2: <span id="selectedLearnerPhone2" style="color: #3b82f6; font-weight: 500;"></span></div>
              </div>
            </div>
            <button 
              id="clearSelection" 
              class="btn btn-secondary btn-sm"
              style="padding: 6px 12px; font-size: 0.85rem;"
            >Clear</button>
          </div>
        </div>

        <input 
          type="tel" 
          id="manualPhone" 
          placeholder="Parent/Guardian Phone 1 (07xxxxxxxx or 01xxxxxxxx)" 
          disabled
        />
        
        <input 
          type="tel" 
          id="manualPhone2" 
          placeholder="Parent/Guardian Phone 2 (Optional)" 
          disabled
        />
        
        <button id="updateSingleBtn" class="btn btn-primary" disabled>
          Update Phone Numbers
        </button>
      </div>

      <div id="manualResult" class="hidden" style="margin-top: 15px;"></div>
    </div>

    <!-- Progress Log -->
    <div class="card">
      <h2>Update Progress Log</h2>
      <div id="progressLog" style="background: #f9fafb; padding: 15px; border-radius: 6px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px;">
        <div class="text-muted">No updates yet. Upload a file to begin.</div>
      </div>
    </div>

  </div>
  
  <script type="module" src="js/bulk-phone-update.js"></script>
</body>
</html>
